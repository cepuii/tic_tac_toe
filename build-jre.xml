<project basedir="." default="build-jre" name="Build JRE for tic-tac-toe game">

  <!-- ******************************* SCRIPT CONFIGS ******************************* -->
  <!-- JPMS modules -->
  <condition property="isCurrentWindows">
    <os family="windows"/>
  </condition>

  <!-- Target directories -->
  <condition property="isWindowsJreBuilt">
    <available file="${target-tmp-dir}/${jre-windows-dir-name}/bin/java.exe"/>
  </condition>
  <condition property="isCurrentLinux">
    <and>
      <not>
        <os family="macos"/>
      </not>
      <os family="unix"/>
    </and>
  </condition>
  <condition property="isLinuxJreBuilt">
    <available file="${target-tmp-dir}/${jre-linux-dir-name}/bin/java"/>
  </condition>

  <!-- JDK download links -->
  <macrodef name="build-jre">
    <attribute name="destDir"/>
    <attribute name="modulePath"/>
    <sequential>
      <echo level="info"
        message="Build JRE using '@{modulePath}' module path into '${target-tmp-dir}/@{destDir}' directory"/>
      <exec executable="${env.JAVA_HOME}/bin/jlink" failonerror="true">
        <arg line='--add-modules "${java.modules}"'/>
        <arg line='--module-path "@{modulePath}"'/>
        <arg line='--output ${target-tmp-dir}/@{destDir}'/>
        <arg line='--no-header-files --no-man-pages --compress 2'/>
      </exec>
    </sequential>
  </macrodef>
  <property name="java.modules"
    value="java.base"/>

  <property name="target-tmp-dir"
    value=".tmp"/>

  <!-- *************************************** TARGETS *************************************** -->
  <property name="jre-windows-dir-name"
    value="jre-wind"/>

  <property name="jre-linux-dir-name"
    value="jre-unix"/>

  <!-- *********************************** FOR WINDOWS PLATFORM *********************************** -->
  <property name="jdk-windows-download-link"
    value="https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_windows-x64_bin.zip"/>

  <property name="jdk-linux-download-link"
    value="https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_linux-x64_bin.tar.gz"/>

  <property environment="env"/>

  <target depends="build-windows-jre, build-linux-jre"
    name="build-jre"/>

  <target name="init">
    <mkdir dir="${target-tmp-dir}"/>
    <mkdir dir="${target-tmp-dir}/jdk"/>
  </target>

  <target depends="init" name="build-windows-jre" unless="isWindowsJreBuilt">
    <antcall target="build-windows-jre-if-windows"/>
    <antcall target="build-windows-jre-if-not-windows"/>
  </target>

  <!-- *********************************** FOR LINUX PLATFORM *********************************** -->
  <target if="isCurrentWindows" name="build-windows-jre-if-windows">
    <build-jre destDir="jre-wind" modulePath="${env.JAVA_HOME}/jmods/"/>
  </target>

  <target name="build-windows-jre-if-not-windows" unless="isCurrentWindows">
    <antcall target="download-windows-jdk"/>
    <build-jre destDir="jre-windows"
      modulePath="${target-tmp-dir}/jdk/jdk-windows/jdk-11.0.2/jmods"/>
  </target>

  <target name="download-windows-jdk">
    <echo level="info"
      message="Download JDK using '${jdk-windows-download-link}' link"/>
    <get dest="${target-tmp-dir}/jdk/jdk-windows.zip" skipexisting="true"
      src="${jdk-windows-download-link}"/>
    <unzip dest="${target-tmp-dir}/jdk/jdk-windows" src="${target-tmp-dir}/jdk/jdk-windows.zip"/>
  </target>

  <target depends="init" name="build-linux-jre" unless="isLinuxJreBuilt">
    <antcall target="build-linux-jre-if-linux"/>
    <antcall target="build-linux-jre-if-not-linux"/>
  </target>

  <target if="isCurrentLinux" name="build-linux-jre-if-linux">
    <build-jre destDir="${jre-linux-dir-name}" modulePath="${env.JAVA_HOME}/jmods/"/>
  </target>

  <target name="build-linux-jre-if-not-linux" unless="isCurrentLinux">
    <antcall target="download-linux-jdk"/>
    <build-jre destDir="${jre-linux-dir-name}"
      modulePath="${target-tmp-dir}/jdk/jdk-linux/jdk-11.0.2/jmods"/>
  </target>

  <!-- ********************************* MACRO DEFINITIONS ************************************* -->
  <target name="download-linux-jdk">
    <echo level="info"
      message="Download JDK using '${jdk-linux-download-link}' link"/>
    <get dest="${target-tmp-dir}/jdk/jdk-linux.tar.gz" skipexisting="true"
      src="${jdk-linux-download-link}"/>
    <untar compression="gzip" dest="${target-tmp-dir}/jdk/jdk-linux"
      src="${target-tmp-dir}/jdk/jdk-linux.tar.gz"/>
  </target>
</project>